ğŸ› ï¸ Instructions for Fixing the Project â€“ SocialMediaScheduler
Please review and fix the following issues across the project:

1. ğŸ”’ Fix requireAuth Middleware
Unify the requireAuth implementation so that it uses JWT via Authorization: Bearer <token> header only.

Extract the user ID from the token and assign it to req.user (or req.user.id).

Do not rely on req.session or Replitâ€™s session-based auth.

2. ğŸ“¦ Remove Redundant Storage Logic
The code currently uses both storage.ts and storage-new.ts (secureStorage).

Unify storage logic into one single file (preferably secureStorage).

Remove any duplicated logic and make sure only one source of truth is used for auth tokens, cached posts, and user data.

3. ğŸ”‘ Use Per-User Access Tokens
Make sure getAuthToken('youtube', userId) and saveAuthToken(token, userId) are used everywhere, not global token logic.

Also apply this logic to all relevant services, including YouTube, Facebook, and internal helpers.

4. âš™ï¸ Check /api/youtube/token Usage
Confirm if /api/youtube/token is necessary. It appears to be redundant with /api/youtube-auth-callback.

Either remove it or update the frontend so it uses only one of them consistently.

5. ğŸ“¹ Fix /api/youtube/videos Endpoint
This endpoint currently returns 401 due to missing or invalid auth.

After fixing requireAuth, ensure it retrieves the userâ€™s token correctly.

Handle 403 Forbidden errors and add logic to refresh tokens using refresh_token if the access token has expired.

6. âœ… Fix /api/youtube/auth-status
This endpoint incorrectly assumes a global token.

It should check if the current user (req.user.id) has a valid YouTube token via getAuthToken('youtube', req.user.id).

7. ğŸ”„ Implement Token Refresh Logic
In youtubeService.ts, use refresh_token to refresh the access token when needed.

Add fallback handling when tokens expire.

8. ğŸ§ª Use testConnection Function
In the YouTube service, use testConnection(accessToken) to verify token validity before making API calls.

If the connection fails, trigger token refresh and retry the action.

